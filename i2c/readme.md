# I2C protocol controller
I2C (pronounced I squared C) is a serial communication protocol. It uses a slave-master configuration and uses half duplex mode, meaning data transfer can happen only in one direction at a given time. It is synchronous, meaning it has a clock signal.

There are 2 lines : 
- A data line, called SDA (Serial Data)
- A clock line, called SCL (Serial Clock)
- (and a common ground obviously)

![Image credits to circuitbasics.com[1]](./docs/diag_1.png)

The clock signal is always controlled by the master and the data signal can be controlled by either the master or the slave. Both the clock and data lines are open-collector or open-drain, with a pull-up resistor. Typically, 5v and 3.3v are used. Due to pull-up, the data lines are by default in high state.

A single pullup resistor should be used, external to the master and the slave. This makes it possible to use multiple masters at the same time. The **pullup resistor** and **open-drain** configuration create a **wired AND** gate. The resistors are typically somewhere in the range 1kOhm to 10kOhm. The value depends on factors like series resitance of bus which can cause LOW signal to not be recognized properly.

To check how parameters of the bus lines affect communication, check out i2c-bus.org[2]

---

## Timing

![Timing diagram from i2c specification[4]](./docs/diag_3.png)

---

## Message format

![Image credits to circuitbasics.com[1]](./docs/diag_2.png)

- Each message starts with a START bit and ends with a STOP bit. They are always generated by the master.
    - SDA ```negedge``` then SCL ```negedge```
    - SCL ```posedge``` then SDA ```posedge```

    ![Start and stop Timing diagram from i2c specification[4]](./docs/diag_4.png)

- The address frame consists of a 7 or 10 bit address specific to each slave device.

- Another bit is sent, indicating if the master wants to perform a read or a write to the slave.
  - low - write, 
  - high - read

- An ACK bit follows, which indicates if the address frame and read/write bit was received. If a slave recognizes the address, it pulls down the SDA line. If the SDA line is not pulled down, the master knows that the message was not received or the address was not found. The same mechanism is used to confirm reception of data frames, by both the slave and master. An ACK signal may not be generated if
  1. No receiver is present on the bus with the transmitted address so there is no device to
  respond with an acknowledge.
  2. The receiver is unable to receive or transmit because it is performing some real-time
  function and is not ready to start communication with the master.
  3. During the transfer, the receiver gets data or commands that it does not understand.
  4. During the transfer, the receiver cannot receive any more data bytes.
  5. A master-receiver must signal the end of the transfer to the slave transmitter.

- Each data frame contains 8 bits, and is followed by an ACK bit. The data is sent MSB first.

---

## Requirements for devices
- SDA, SCL must be open-drain
- SDA, SCL must be sampled by schmitt-trigger circuits
- The signals must be held high or low (excluding the edge) for some minimum amount of time.

---

## Clock stretching and arbitration

The slave can hold the SCL line low for some time if it needs to slow down the data transfer. The master must read the SCL line to see if this is being done. This practice is called **clock stretching**. This can be done for as much time as the slave wants

i2c speciication also allows multiple master systems. Both masters concurrently monitor SCL and SDA signals and check if some other master is communicating. If not, it starts its transfer, else it delays them. If 2 masters start communicating simulataneously, the masters check if SDA and SCL are what they expect they are. If SDA is low but they expect it to be high, they can be sure that some other master is using the bus. Then, it stops its transfer. This is called **arbitration**

---

## References
1) https://www.circuitbasics.com/basics-of-the-i2c-communication-protocol/#:~:text=I2C%20is%20a%20serial%20communication,always%20controlled%20by%20the%20master.
2) https://www.i2c-bus.org/
3) https://en.wikipedia.org/wiki/I%C2%B2C
4) https://www.nxp.com/docs/en/user-guide/UM10204.pdf
